require 'readline'
require 'pathname'
require 'fileutils'
require 'os'

if OS.mac?
  # Keyboard preferences
  unless system 'defaults write -g InitialKeyRepeat -int 25 && defaults write -g KeyRepeat -int 2 && defaults write -g ApplePressAndHoldEnabled -bool false'
    raise 'Error setting keyboard preferences.'
  end
  puts 'Keyboard preferences set successfully'

  # homebrew installation
  unless system 'which brew'
    puts 'Installing homebrew...'
    unless system 'ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"'
      raise 'Error installing homebrew.'
    end
    puts 'homebrew successfully installed!'
  else
    puts 'homebrew already installed.'
  end

  puts 'Tapping brew-bundle...'
  unless system 'brew tap Homebrew/bundle'
    raise 'Error tapping Homebrew/bundle.'
  end
  puts 'brew-bundle successfully installed!'

  # Brewfile installation
  puts 'Installing Brewfile bundle...'
  unless system 'brew bundle'
    raise 'Error installing Brewfile bundle.'
  end
  puts 'Brewfile bundle successfully installed!'
end

# oh-my-zsh installation
ohmyzsh_path = Pathname.new "#{Dir.home}/.oh-my-zsh"
unless ohmyzsh_path.exist?
  puts 'Installing oh-my-zsh...'
  unless system 'git clone https://github.com/robbyrussell/oh-my-zsh.git ~/.oh-my-zsh'
    raise 'Error installing oh-my-zsh'
  end
  system 'chmod g-w,o-w .oh-my-zsh'
  puts 'oh-my-zsh installed!'
else
  puts 'oh-my-zsh already installed.'
end

puts 'Setting zsh as default shell...'
if OS.mac?
  system 'sudo echo "/usr/local/bin/zsh" >> /etc/shells'
  system 'chsh -s /usr/local/bin/zsh'
else
  system 'chsh -s /bin/zsh'
end

if OS.mac?
  puts "Installing Powerline fonts..."
  # Install powerline-fonts
  FileUtils.cp Dir.glob("./vendor/powerline-fonts/SourceCodePro/*.otf"), "#{Dir.home}/Library/Fonts/"
end

# Private info prompts
puts "Configuring git..."
email = Readline.readline('Email address: ')
unless system "git config --file ~/.gitconfig-private user.email #{email}"
  raise 'Error setting email address in git.'
end
puts 'Email address set in git global configuration'
